@if (game) {
  <div class="game-detail">
    <!-- HEADER CON IMAGEN DE FONDO -->
    <div class="header">
      <div class="header-overlay"></div>
      <img [src]="game.backgroundImage" [alt]="game.name" class="cover" />
      
      <div class="header-content">
        <h1>{{ game.name }}</h1>

      <div class="meta-info">

        <span class="rating-badge" *ngIf="game.rating">
          <img src="assets/images/icons/star-filled.svg" alt="‚≠ê">
          {{ game.rating | number:'1.1-1' }}/5
        </span>

        <span class="playtime-info">
          <span class="time rushed">
            ‚è± Rushed <strong>{{ averageTimes?.hastily ?? 'N/A' }}h</strong>
          </span>

          <span class="time normal">
            üéÆ Normal <strong>{{ averageTimes?.normally ?? 'N/A' }}h</strong>
          </span>

          <span class="time complete">
            üèÜ 100% <strong>{{ averageTimes?.completely ?? 'N/A' }}h</strong>
          </span>
        </span>

      </div>
        
      </div>
    </div>

    <!-- ACCIONES Y BOTONES -->
    <div class="actions-bar">
      <app-game-actions [game]="game"></app-game-actions>
      
      <button class="btn-review" (click)="modalManager.openReviewModal(game)" [disabled]="!game">
        <img src="/assets/images/icons/pencil.svg" alt=""> Write Review
      </button>
    </div>

    <!-- TABS DE NAVEGACI√ìN -->
    <div class="tabs">
      <button 
        class="tab" 
        [class.active]="activeTab === 'overview'"
        (click)="activeTab = 'overview'">
        Overview
      </button>
      <button 
        class="tab" 
        [class.active]="activeTab === 'media'"
        (click)="activeTab = 'media'">
        Media
      </button>
      <button 
        class="tab" 
        [class.active]="activeTab === 'reviews'"
        (click)="activeTab = 'reviews'">
        Reviews ({{ reviews.length }})
      </button>
    </div>

    <!-- TAB: OVERVIEW -->
    @if (activeTab === 'overview') {
      <div class="overview-content">
        <!-- DESCRIPCI√ìN -->
        <div class="description-section">
          <h2>About</h2>
        <span class="release-date" *ngIf="game.released">
          <span>Released:</span> {{ game.released | date:'mediumDate' }}
        </span>
          <p [innerHTML]="game.description || 'No description available.'"></p>
        </div>

        <!-- TRAILER -->
        @if (game.trailerUrl) {
          <div class="trailer-section">
            <div class="trailer-wrapper">
              <iframe
                [src]="safeTrailerUrl"
                title="Game trailer"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen>
              </iframe>
            </div>
          </div>
        }
        

        <!-- INFORMACI√ìN ADICIONAL -->
        <div class="info-grid">
          @if (game.platforms && game.platforms.length > 0) {
          <div class="info-card">
            <h3>Platforms</h3>

            <div class="platforms-info">
              @for (platform of game.platforms; track platform) {
                <span class="platform">{{ platform }}</span>
              }
            </div>
          </div>
          }

          @if (game.genres && game.genres.length > 0) {
          <div class="info-card">
            <h3>Genres</h3>

            <div class="genres-info">
              @for (genre of game.genres; track genre) {
                <span class="genre">{{ genre }}</span>
              }
            </div>
          </div>
          }


          @if (game.metacritic) {
            <div class="info-card">
              <h3>Metacritic Score</h3>
              <p class="metacritic-score">{{ game.metacritic | number:'1.0-0' }}</p>
            </div>
          }
        </div>
      </div>
    }

    <!-- TAB: MEDIA -->
    @if (activeTab === 'media') {
      <div class="media-content">
        <!-- SCREENSHOTS -->
        @if (game.screenshots && game.screenshots.length > 0) {
          <div class="screenshots-section">
            <h2>Screenshots</h2>
            <div class="screenshots-grid">
              @for (screenshot of game.screenshots; track screenshot; let i = $index) {
                <div class="screenshot-item" (click)="openLightbox(i)">
                  <img 
                    [src]="screenshot" 
                    [alt]="game.name + ' screenshot ' + (i + 1)"
                    loading="lazy"
                  />
                </div>
              }
            </div>
          </div>
        } @else {
          <p class="empty-state">No screenshots available</p>
        }
      </div>
    }

    <!-- TAB: REVIEWS -->
    @if (activeTab === 'reviews') {
      <div class="reviews-content">
        <div class="reviews-header">
          <h2>Community Reviews</h2>

          <button
            *ngIf="reviews.length > 4 && !showAll"
            class="see-all-btn"
            (click)="showAll = true">
            See all reviews ‚Üí
          </button>

          <button
            *ngIf="showAll"
            class="see-all-btn back"
            (click)="showAll = false">
            ‚Üê Show less
          </button>
        </div>

        <p *ngIf="reviews.length === 0" class="empty-state">
          No reviews yet. Be the first to review this game!
        </p>

        <div class="reviews-grid" *ngIf="!showAll && limitedReviews.length > 0">
          <div class="review-card" *ngFor="let r of limitedReviews">
            <div class="review-header">
              <img class="avatar" [src]="r.profileImage || placeholderImage" alt="User avatar" />
              <div class="user-meta">
                <h4>{{ r.displayName || r.username }}</h4>
                <small class="date">{{ r.createdAt | date:'mediumDate' }}</small>
              </div>
            </div>
            <div class="review-meta">
              <span *ngIf="r.rating" class="badge rating">‚≠ê {{ r.rating }}/5</span>
              <span *ngIf="r.playtime" class="badge playtime">‚è± {{ r.playtime }}h</span>
            </div>
            <p class="comment">{{ r.review }}</p>
          </div>
        </div>

        <div class="reviews-grid" *ngIf="showAll && reviews.length > 0">
          <div class="review-card" *ngFor="let r of reviews">
            <div class="review-header">
              <img class="avatar" [src]="r.profileImage || placeholderImage" alt="User avatar" />
              <div class="user-meta">
                <h4>{{ r.displayName || r.username }}</h4>
                <small class="date">{{ r.createdAt | date:'mediumDate' }}</small>
              </div>
            </div>
            <div class="review-meta">
              <span *ngIf="r.rating" class="badge rating">‚≠ê {{ r.rating }}/5</span>
              <span *ngIf="r.playtime" class="badge playtime">‚è± {{ r.playtime }}h</span>
            </div>
            <p class="comment">{{ r.review }}</p>
          </div>
        </div>
      </div>
    }
  </div>
} @else {
  <div class="loading-state">
    <p>Loading game details...</p>
  </div>
}

<!-- LIGHTBOX PARA SCREENSHOTS -->
@if (lightboxOpen) {
  <div class="lightbox" (click)="closeLightbox()">
    <button class="lightbox-close" (click)="closeLightbox()">√ó</button>
    
    @if (currentScreenshotIndex > 0) {
      <button class="lightbox-prev" (click)="prevScreenshot($event)">‚Äπ</button>
    }
    
    <img 
      [src]="game.screenshots[currentScreenshotIndex]" 
      [alt]="game.name"
      (click)="$event.stopPropagation()"
    />
    
    @if (currentScreenshotIndex < game.screenshots.length - 1) {
      <button class="lightbox-next" (click)="nextScreenshot($event)">‚Ä∫</button>
    }
    
    <div class="lightbox-counter">
      {{ currentScreenshotIndex + 1 }} / {{ game.screenshots.length }}
    </div>
  </div>
}